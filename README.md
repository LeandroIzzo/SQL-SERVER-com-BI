# SQL SERVER COM BUSINESS INTELLIGENCE
Este repositório contém um projeto utilizando o SQL Server, e o Visual Studio 2015 (Business intelligence, Reporting Services, Integration Services, Analysis Services).
Esse é um projeto de estudo. Os scripts construidos foram feitos no Microsoft SQL Server Management Studio. As modelagens foram feitas no StarUML. E os processos de ETL foram feitos no Visual Studio 2015.

# INTRODUÇÃO
A loja musical necessita armazenar o seus funcionários, metodos de pagamento, o cadastro de clientes, produtos, fornecedores, marcas, categorias, subcategorias,
os protudos das notas fiscais, e as notas fiscais. Também querem guardar seus dados de vendas, custos e lucros. Não importando saber quem vendeu ou quantas vendas cada funcionário fez. Eles desejam saber em que época do ano tem mais vendas e também em quais meses. Gostariam de ter uma análise de vendas por categoria, subcategoria e marcas.

# OBJETIVO
O objetivo deste projeto é demonstrar a criação de um banco de dados relacional de uma loja musical. Fazendo a criação do Ambiente OLTP, Staging Area, Datawarehouse, Ambiente OLAP, CUBO(Analysis Services), Reporting Services para atender todas as necessidades da loja.

# ETAPA 1 - CRIAÇÃO DO AMBIENTE OLTP
Nesta primeira etapa, será criado o database, e a estrutura das tabelas com base na modelagem.

# MODELAGEM OLTP
![modelagemOLTP](https://github.com/LeandroIzzo/SQL-SERVER-com-BI/blob/main/MOGELAGEM%20DE%20DADOS/1.%20MODELAGEM%20OLTP.jpg?raw=true)

CRIAÇÃO DA DATABASE DA LOJA MUSICAL (OLTP):
```
  CREATE DATABASE LOJA_INSTRUMENTOS_OLTP
  GO
```

UTILIZANDO O DATABASE:
```
  USE LOJA_INSTRUMENTOS_OLTP
  GO
```

CRIAÇÃO DA TABELA PARA O ARMAZENAMENTO DOS PRODUTOS:
```
CREATE TABLE PRODUTOS(
	IDPRODUTO INT IDENTITY,
	PRODUTO VARCHAR(70) NOT NULL,
	VALOR NUMERIC(10,2) NOT NULL,
	CUSTO_MEDIO NUMERIC(10,2) NOT NULL,
	ID_CATEGORIA INT NOT NULL,
	ID_MARCA INT NOT NULL,
	ID_FORNECEDOR INT NOT NULL,
	ID_SUBCATEGORIAS INT NOT NULL,
	CONSTRAINT PK_PRODUTO PRIMARY KEY(IDPRODUTO) 
)
GO
```
CRIAÇÃO DA TABELA MARCAS:
```
CREATE TABLE MARCAS(
	IDMARCA INT IDENTITY,
	MARCA VARCHAR(25) NOT NULL,
	CONSTRAINT PK_MARCA PRIMARY KEY(IDMARCA) 
)
GO
```
CRIAÇÃO DA TABELA CATEGORIAS:
```
CREATE TABLE CATEGORIAS(
	IDCATEGORIA INT IDENTITY,
	CATEGORIA VARCHAR(25) NOT NULL,
	CONSTRAINT PK_CATEGORIA PRIMARY KEY(IDCATEGORIA)
)
GO
```
CRIAÇÃO DA TABELA SUBCATEGORIAS:
```
CREATE TABLE SUB_CATEGORIAS(
	IDSUB INT IDENTITY,
	SUB_CATEGORIA VARCHAR(30) NOT NULL,
	ID_CATEGORIA INT NOT NULL,
	CONSTRAINT PK_SUBCTG PRIMARY KEY(IDSUB) 
)
GO
```
CRIAÇÃO DA TABELA FORNECEDORES:
```
CREATE TABLE FORNECEDORES(
	IDFORNECEDOR INT IDENTITY,
	FORNECEDOR VARCHAR(25) NOT NULL,
	CONSTRAINT PK_FORNECEDOR PRIMARY KEY(IDFORNECEDOR)
)
GO
```
CRIAÇÃO DA TABELA CLIENTES:
```
CREATE TABLE CLIENTES(
	IDCLIENTE INT IDENTITY,
	NOME VARCHAR(20) NOT NULL,
	SOBRENOME VARCHAR(35) NOT NULL,
	SEXO CHAR(1) CONSTRAINT CK_SEXO CHECK (SEXO IN ('M', 'F')) NOT NULL,
	NASCIMENTO DATE NOT NULL,
	EMAIL VARCHAR(50) NOT NULL,
	RUA VARCHAR(30) NOT NULL,
	CIDADE VARCHAR(20) NOT NULL,
	UF CHAR(2) NOT NULL,
	CONSTRAINT PK_CLIENTE PRIMARY KEY(IDCLIENTE)
)
GO
```
CRIAÇÃO DA TABELA FUNCIONARIOS:
```
CREATE TABLE FUNCIONARIOS(
	IDFUNCIONARIO INT IDENTITY,
	FUNCIONARIO VARCHAR(45) NOT NULL,
	SEXO CHAR(1) CONSTRAINT CK_SEXO_FUN CHECK (SEXO IN ('M', 'F')) NOT NULL,
	NASCIMENTO DATE NOT NULL,
	EMAIL VARCHAR(40) NOT NULL,
	RUA VARCHAR(30) NOT NULL,
	CIDADE VARCHAR(20) NOT NULL,
	UF CHAR(2) NOT NULL,
	CARGO VARCHAR(30) NOT NULL,
	SALARIO NUMERIC(10,2) NOT NULL,
	CONSTRAINT PK_FUNCIONARIO PRIMARY KEY(IDFUNCIONARIO)
)
GO
```
CRIAÇÃO DA TABELA METODO DE PAGAMENTO:
```
CREATE TABLE METODO_PAGAMENTO(
	IDMETODO INT IDENTITY,
	FORMA_DE_PAGAMENTO VARCHAR(35) NOT NULL,
	CONSTRAINT PK_METODO PRIMARY KEY(IDMETODO)
)
GO
```
CRIAÇÃO DA TABELA NOTA FISCAL:
```
CREATE TABLE NOTA_FISCAL(
	IDNOTAFISCAL INT IDENTITY,
	DATA DATE DEFAULT GETDATE() NOT NULL,
	TOTAL DECIMAL(10,2),
	ID_FORMA INT NOT NULL,
	ID_CLIENTE INT NOT NULL,
	ID_FUNCIONARIO INT NOT NULL,
	CONSTRAINT PK_NOTA PRIMARY KEY(IDNOTAFISCAL)
)
GO
```
CRIAÇÃO DA TABELA ITENS DA NOTA FISCAL:
```
CREATE TABLE ITEM_NOTA(
	IDITEMNOTA INT IDENTITY,
	QUANTIDADE INT,
	VALOR NUMERIC(10,2),
	ID_PRODUTO INT NOT NULL,
	ID_NOTA_FISCAL INT NOT NULL,
	CONSTRAINT PK_ITEM PRIMARY KEY(IDITEMNOTA)
)
GO
```

# ETAPA 2 - RELACIONAMENTO ENTRA AS TABELAS
Nesta etapa iremos crias as Foreign Key(FK) para relacionar as tabelas. 
Elas foram criadas fora do script de criação de tabelas para termos um dicionário de dados.

CRIANDO OS RELACIONAMENTOS ENTRE TABELAS, FOREIGNS KEYS REFERENTES AS TABELAS:

PRODUTOS E CATEGORIAS:
```
ALTER TABLE PRODUTOS ADD CONSTRAINT FK_PROD_CATG
FOREIGN KEY(ID_CATEGORIA) REFERENCES CATEGORIAS(IDCATEGORIA)
GO
```
PRODUTOS E MARCAS:
```
ALTER TABLE PRODUTOS ADD CONSTRAINT FK_PROD_MARCA
FOREIGN KEY(ID_MARCA) REFERENCES MARCAS(IDMARCA)
GO
```
PRODUTOS E FORNECEDORES:
```
ALTER TABLE PRODUTOS ADD CONSTRAINT FK_PROD_FORNCEDORES 
FOREIGN KEY(ID_FORNECEDOR) REFERENCES FORNECEDORES(IDFORNECEDOR)
GO
```
NOTA FISCAL E FORMA DE PAGAMENTO:
```
ALTER TABLE NOTA_FISCAL ADD CONSTRAINT FK_NOTA_FORMA
FOREIGN KEY(ID_FORMA) REFERENCES METODO_PAGAMENTO(IDMETODO)
GO
```
NOTA FISCAL E CLIENTES:
```
ALTER TABLE NOTA_FISCAL ADD CONSTRAINT FK_NOTAS_CLIENTE
FOREIGN KEY(ID_CLIENTE) REFERENCES CLIENTES(IDCLIENTE)
GO
```
ITENS DE NOTA E PRODUTOS:
```
ALTER TABLE ITEM_NOTA ADD CONSTRAINT FK_ITEM_PROD
FOREIGN KEY(ID_PRODUTO) REFERENCES PRODUTOS(IDPRODUTO)
GO
```
ITENS DE NOTA E NOTA FISCAL:
```
ALTER TABLE ITEM_NOTA ADD CONSTRAINT FK_ITEM_NOTAFISCAL
FOREIGN KEY(ID_NOTA_FISCAL) REFERENCES NOTA_FISCAL(IDNOTAFISCAL)
GO
```
PRODUTOS E SUBCATEGORIAS:
```
ALTER TABLE PRODUTOS ADD CONSTRAINT FK_PRODUTO_SUBCATE 
FOREIGN KEY(ID_SUBCATEGORIAS) REFERENCES SUB_CATEGORIAS(IDSUB)
GO
```
SUBCATEGORIAS E CATEGORIAS:
```
ALTER TABLE SUB_CATEGORIAS ADD CONSTRAINT FK_SUBCATEG_CATEGO 
FOREIGN KEY(ID_CATEGORIA) REFERENCES CATEGORIAS(IDCATEGORIA)
GO
```
NOTA FISCAL E FUNCIONARIO:
```
ALTER TABLE NOTA_FISCAL ADD CONSTRAINT FK_NOTA_FUNC
FOREIGN KEY(ID_FUNCIONARIO) REFERENCES FUNCIONARIOS(IDFUNCIONARIO)
GO
```

# ETAPA 3 - ADICIONANDO DADOS
Nesta etapa iremos adicionar os dados de todas as tabelas.
OBS: Os dados completos de todas as tabelas, estão na pasta scripts.

ADICIONANDO DADOS NA TABELA CATEGORIAS:
```
	INSERT INTO CATEGORIAS VALUES('Acessórios')
	INSERT INTO CATEGORIAS VALUES('Igreja')
	INSERT INTO CATEGORIAS VALUES('Sopro')
	INSERT INTO CATEGORIAS VALUES('Teclas')
	INSERT INTO CATEGORIAS VALUES('Cordas')
	INSERT INTO CATEGORIAS VALUES('Livros')
	INSERT INTO CATEGORIAS VALUES('Outlet')
	INSERT INTO CATEGORIAS VALUES('Percussão')
	INSERT INTO CATEGORIAS VALUES('Áudio')
	GO
```
ADICIONANDO DADOS NA SUBCATEGORIAS:
```
-- Audio = 9
	INSERT INTO SUB_CATEGORIAS VALUES('Afinador/Metronomo', 9)
	INSERT INTO SUB_CATEGORIAS VALUES('Cabos e Adptadores', 9)

-- Percurssão = 8
	INSERT INTO SUB_CATEGORIAS VALUES('Pandeiros', 8)
	INSERT INTO SUB_CATEGORIAS VALUES('Baqueta', 8)

-- Outlet = 7
	INSERT INTO SUB_CATEGORIAS VALUES('Estojo', 7)
	INSERT INTO SUB_CATEGORIAS VALUES('Bíblias', 7)

-- Livros = 6
	INSERT INTO SUB_CATEGORIAS VALUES('Métodos Cordas', 6)
	INSERT INTO SUB_CATEGORIAS VALUES('Métodos Diversos', 6)

-- Cordas = 5
	INSERT INTO SUB_CATEGORIAS VALUES('Cavaquinhos', 5)
	INSERT INTO SUB_CATEGORIAS VALUES('Viola de Arco', 5)

-- Teclas = 4
	INSERT INTO SUB_CATEGORIAS VALUES('Escaleta', 4)
	INSERT INTO SUB_CATEGORIAS VALUES('Pianos', 4)

-- Sopro = 3
	INSERT INTO SUB_CATEGORIAS VALUES('Gaita', 3)
	INSERT INTO SUB_CATEGORIAS VALUES('Bombardinos', 3)
	INSERT INTO SUB_CATEGORIAS VALUES('Clarinetes', 3)

-- Igreja = 2
	INSERT INTO SUB_CATEGORIAS VALUES('Acessórios', 2)
	INSERT INTO SUB_CATEGORIAS VALUES('Caixa de Coleta', 2)

-- Acessorios = 1
	INSERT INTO SUB_CATEGORIAS VALUES('Abraçadeiras', 1)
	INSERT INTO SUB_CATEGORIAS VALUES('Arcos', 1)
	GO
```
ADICIONANDO MARCAS:
```
	INSERT INTO MARCAS VALUES('CSR')
	INSERT INTO MARCAS VALUES('Dolphin')
	INSERT INTO MARCAS VALUES('Free Sax')
	INSERT INTO MARCAS VALUES('Saty')
	INSERT INTO MARCAS VALUES('JBL')
	INSERT INTO MARCAS VALUES('Sony')
	INSERT INTO MARCAS VALUES('Philips')
	INSERT INTO MARCAS VALUES('Paganini')
	GO
```
ADICIONANDO METODO DE PAGAMENTOS:
```
	INSERT INTO METODO_PAGAMENTO VALUES('Tranferência - Vista')
	INSERT INTO METODO_PAGAMENTO VALUES('Depósito - Vista')
	INSERT INTO METODO_PAGAMENTO VALUES('Boleto - Vista')
	INSERT INTO METODO_PAGAMENTO VALUES('PicPay - Vista')
	INSERT INTO METODO_PAGAMENTO VALUES('Mercado Pago - Vista')
	INSERT INTO METODO_PAGAMENTO VALUES('Cartão Master 2 vezes')
	INSERT INTO METODO_PAGAMENTO VALUES('Cartão Visa 2 vezes')
	INSERT INTO METODO_PAGAMENTO VALUES('Cartão Visa 3 vezes')
	INSERT INTO METODO_PAGAMENTO VALUES('Cartão American 5 vezes')
	INSERT INTO METODO_PAGAMENTO VALUES('Cartão Visa 2 vezes')
	INSERT INTO METODO_PAGAMENTO VALUES('Pay Pall - 5 vezes')
	INSERT INTO METODO_PAGAMENTO VALUES('Pag Seguro Web - Vista')
	INSERT INTO METODO_PAGAMENTO VALUES('Cheque - Vista')
	INSERT INTO METODO_PAGAMENTO VALUES('Pic Pay - Vista')
	INSERT INTO METODO_PAGAMENTO VALUES('Mercado Pago - Vista')
	GO
```
ADICIONANDO FORNECEDORES:
```
	INSERT INTO FORNECEDORES VALUES('Alibaba')
	INSERT INTO FORNECEDORES VALUES('Oderço')
	INSERT INTO FORNECEDORES VALUES('ZadSom')
	INSERT INTO FORNECEDORES VALUES('Guimarães Comercial')
	INSERT INTO FORNECEDORES VALUES('Izzo Instrumentos')
	INSERT INTO FORNECEDORES VALUES('Hayamax')
	INSERT INTO FORNECEDORES VALUES('Musitech')
	INSERT INTO FORNECEDORES VALUES('Kyodday Comércio')
	GO
```
ADICIONANDO PRODUTOS:
```
	INSERT INTO PRODUTOS VALUES('Queixeira Guarnieri Violino 3/4 4/4 em Ébano Hill', 113.68,80.50,1,24,3,53)
	INSERT INTO PRODUTOS VALUES('Queixeira Violino 4/4 em Ébano', 120.00, 85.00, 1, 23, 2, 53)
	INSERT INTO PRODUTOS VALUES('Queixeira Violino 4/4 - Madeira', 105.00, 75.00, 1, 8, 1, 53)
	INSERT INTO PRODUTOS VALUES('Suporte Estante Dobrável Compacta para Partitura',339.00,280.00,1,30,7,52)
	INSERT INTO PRODUTOS VALUES('Estante para Piano Digital YAMAHA',869.00,680.00,1,10,3,52)
	INSERT INTO PRODUTOS VALUES('Polidor Instrumentos Niquelados',90.00,40.00,1,10,3,51)
	INSERT INTO PRODUTOS VALUES('Surdina para Trombone',230.00,175.00,1,1,2,50)
	INSERT INTO PRODUTOS VALUES('Surdina Tour te Round',12.87,4.13,1,43,4,50)
	INSERT INTO PRODUTOS VALUES('Surdina de Metal Violino',112.20,68.70,1,8,1,50)
	INSERT INTO PRODUTOS VALUES('Prendedor de Partitura Clave de Sol',18.00,7.00,1,8,8,49)
	INSERT INTO PRODUTOS VALUES('Palheta para violão Fina',13.20,5.20,1,8,8,48)
	INSERT INTO PRODUTOS VALUES('Palhetapara Sax Alto',35.00,20.00,1,45,2,48)
	INSERT INTO PRODUTOS VALUES('Plaheta para Sax ALto',23.00,9.00,1,26,1,48)
	INSERT INTO PRODUTOS VALUES('Bocal para trompa prateado nºW15 - VFH',78.00,32.00,1,17,5,47)
	INSERT INTO PRODUTOS VALUES('Bocal para Bombardino 6 1/2 AL',80.00,46.00,1,2,4,47)
	INSERT INTO PRODUTOS VALUES('Breu para Violino/Viola - Preto',15.00,6.00,1,8,3,46)
	INSERT INTO PRODUTOS VALUES('Breu para Violino e Viola Black',40.00,27.00,1,24,7,46)
	INSERT INTO PRODUTOS VALUES('Capa Preta para Violão ou Violão 12 Cordas',452.00,388.00,1,21,6,45)
	INSERT INTO PRODUTOS VALUES('Capa Capota Preta para Sax Alto',252.96,198.04,1,21,6,45)
```
# ETAPA 4 - CRIANDO DADOS PARA AS NOTAS FISCAIS E OS ITENS DE NOTA
CRIANDO E ADICIONANDO DADOS DE FORMA ALEATORIA NAS NOTAS FISCAIS, COMO SE FOSSEM COMPRAS FEITAS:
```
/* 
ADICIONANDO DADOS NAS NOTAS FISCAIS 
1- CLIENTE ALEATORIO;
2- FUNCIONARIO ALEATORIO;
3- FORMA DE PAGAMENTO/METODO DE PAGAMENTO ALEATORIA
4- ANO/MES/DIA ALEATORIO 
	OBS: RODAREI CADA ANO 5000 VEZES (2019,2020,2021)
	PARA CRIAR 15.000
*/

DECLARE
		@ID_CLIENTE INT, @ID_FUNCIONARIO INT, @ID_FORMA INT,
		@DATA DATE

BEGIN
		SET @ID_CLIENTE = 
		(SELECT TOP 1 IDCLIENTE FROM CLIENTES ORDER BY NEWID())

		SET @ID_FUNCIONARIO =
		(SELECT TOP 1 IDFUNCIONARIO FROM FUNCIONARIOS ORDER BY NEWID())

		SET @ID_FORMA =
		(SELECT TOP 1 IDMETODO FROM METODO_PAGAMENTO ORDER BY NEWID())
		
		/* CRIANDO UMA DATA ALEATORIA*/
		/* CADA VEZ QUE RODAR O COMANDO, ALTERE O 2019 POR 2020 E DEPOIS PARA 2021 */
		SET @DATA = (SELECT
					CONVERT(DATE, CONVERT(VARCHAR(15),'2019-' +
					CONVERT(VARCHAR(5),(CONVERT(INT,RAND()*12)) + 1) + '-' +
					CONVERT(VARCHAR(5),(CONVERT(INT,RAND()*27)) + 1))))

		INSERT INTO NOTA_FISCAL(ID_CLIENTE,ID_FUNCIONARIO,ID_FORMA, DATA)   
		VALUES			(@ID_CLIENTE,@ID_FUNCIONARIO,@ID_FORMA,@DATA)		 

END
GO 5000 --VAI EXECUTAR 5000 VEZES
```
ADICIONANDO ITENS NA NOTA FISCAL:
```
-- OBS: Execute esse comando de acordo com a nota fiscal
-- SELECT COUNT(*) FROM NOTA_FISCAL

DECLARE
		@ID_PRODUTO INT,
		@ID_NOTA_FISCAL INT,
		@QUANTIDADE INT,
		@VALOR NUMERIC(10,2),
		@VALOR_TOTAL NUMERIC(10,2)

BEGIN
		SET @ID_PRODUTO =
		(SELECT TOP 1 IDPRODUTO FROM PRODUTOS ORDER BY NEWID())

		SET @ID_NOTA_FISCAL =
		(SELECT TOP 1 IDNOTAFISCAL FROM NOTA_FISCAL ORDER BY NEWID())

		SET @QUANTIDADE =
		(SELECT ROUND(RAND() * 1 + 1, 0))

		SET @VALOR = 
		(SELECT VALOR FROM PRODUTOS WHERE IDPRODUTO = @ID_PRODUTO)

		SET @VALOR_TOTAL = @QUANTIDADE * @VALOR

		INSERT INTO ITEM_NOTA(ID_PRODUTO,ID_NOTA_FISCAL,QUANTIDADE,VALOR)
			VALUES	     (@ID_PRODUTO,@ID_NOTA_FISCAL,@QUANTIDADE,@VALOR_TOTAL)
END
GO 15000
```
VERIFICANDO AS NOTAS QUE NÃO FORAM PREENCHIDAS:
```
SELECT IDNOTAFISCAL FROM NOTA_FISCAL
WHERE IDNOTAFISCAL NOT IN(SELECT ID_NOTA_FISCAL FROM ITEM_NOTA)
GO
```
PREENCHENDO AS NOTAS FISCAIS SEM ITENS:
```
/* AS NOTAS SERÃO PREENCHIDAS APENAS COM 1 PRODUTO ALEATORIO */
DECLARE

        C_NOTAFISCAL CURSOR FOR
        SELECT IDNOTAFISCAL FROM NOTA_FISCAL
        WHERE IDNOTAFISCAL NOT IN(SELECT ID_NOTA_FISCAL FROM ITEM_NOTA)

DECLARE
        @IDNOTAFISCAL INT,
        @ID_PRODUTO INT,
        @VALOR DECIMAL(10,2)

OPEN C_NOTAFISCAL

FETCH NEXT FROM C_NOTAFISCAL
INTO @IDNOTAFISCAL

WHILE @@FETCH_STATUS = 0
BEGIN
    SET @ID_PRODUTO =
    (SELECT TOP 1 IDPRODUTO FROM PRODUTOS ORDER BY NEWID())

    SET @VALOR =
    (SELECT VALOR FROM PRODUTOS WHERE IDPRODUTO = @ID_PRODUTO)

    INSERT INTO ITEM_NOTA(ID_PRODUTO, ID_NOTA_FISCAL, QUANTIDADE, VALOR)
    VALUES(@ID_PRODUTO, @IDNOTAFISCAL,1, @VALOR)

FETCH NEXT FROM C_NOTAFISCAL
INTO @IDNOTAFISCAL

END

CLOSE C_NOTAFISCAL
DEALLOCATE C_NOTAFISCAL
```
RELATORIO/VIEW DO TOTAL POR NOTA FISCAL:
```
CREATE VIEW V_TOTAL_NOTAFISCAL AS
SELECT ID_NOTA_FISCAL, SUM(VALOR) AS SOMA
FROM ITEM_NOTA
GROUP BY ID_NOTA_FISCAL
```
TOTAL DA SOMA NA CARGA NOTA FISCAL:
OBS: SOMA = TOTAL GASTO NA NOTA
```
CREATE VIEW V_CARGA_NOTAFISCAL AS
SELECT N.IDNOTAFISCAL, N.TOTAL AS TOTAL_NOTA, T.SOMA
FROM NOTA_FISCAL N
INNER JOIN V_TOTAL_NOTAFISCAL T
ON IDNOTAFISCAL = ID_NOTA_FISCAL
GO
```
SOMA = TOTAL DA NOTA
```
UPDATE V_CARGA_NOTAFISCAL SET TOTAL_NOTA = SOMA
GO
```

# ETAPA 5 - STAGING AREA
Nesta etapa iremos realizar os processos de ETL de acordo com as necessidades da loja musical.
Houve uma mudança nos requisitos e eles desejam que o nome e sobrenome do cliente, estejam na mesma coluna como nome completo.

# MODELAGEM STAGE
![modelagemSTAGE]()







